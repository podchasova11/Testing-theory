üí°
–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏:
json.loads (–ø–∞—Ä—Å–∏–Ω–≥ NDJSON)
–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (ValueError –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–ø–∏—Å—è—Ö)
–∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ endpoint –∏ —Ä–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫ (avg, p95)
–ø–∞—Ä—Å–∏–Ω–≥ ISO8601 —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º Z (datetime.strptime)

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –≤ CI —Å–æ–±–∏—Ä–∞—é—Ç—Å—è newline-delimited JSON –ª–æ–≥–∏. HTTP-–º–µ—Ç—Ä–∏–∫ –≤–Ω–µ—à–Ω–µ–≥–æ API;
–ù—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.
–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç NDJSON, (—Å—Ç—Ä–æ–∫–∞, –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ JSON —Å –ø–æ–ª—è–º–∏ timestamp, endpoint, status, response_time_ms), –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å—Ç—Ä–æ–∫—É —Å–æ —Å–≤–æ–¥–∫–æ–π: total, per_endpoint -> count, success_2XX, error_5XX, avg_ms, p95_ms. –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–∞ NDJSON (—Å—Ç—Ä–æ–∫–∞). –§–æ—Ä–º–∞—Ç –≤—ã—Ö–æ–¥–∞: JSON-—Å—Ç—Ä–æ–∫–∞.
–ü—Ä–∏–º–µ—Ä –≤–≤–æ–¥–∞ {"timestamp": "2025-01-01T10:00:00Z", "endpoint":"/orders", "status": 200, "response_time_ms": 120}
{"timestamp":"2025-01-01T10:00:01 Z, –∑–∞–ø—è—Ç–∞—è, "endpoint":"/orders", "status": 500,"response_time_ms": 120}
–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞. –°–∫–æ–±–æ—á–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è. {"total":2, "per_endpoint":{ "/orders":"count": 2, "success_2XX": 1, "errors_5XX:1, "avg_ms":210 –¥–≤–æ–µ—Ç–æ—á–∏–µ 210, "p95_ms":300}}}. –ö—Ä–∏—Ç–∏—á–Ω—ãe –≥—Ä–∞–Ω–∏—á–Ω—ãe —Å–ª—É—á–∞u –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π JSON-—Å—Ç—Ä–æ–∫–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π, —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–±—Ä–æ—Å–∏—Ç—å value error.

–ù–∏–∂–µ –ø—Ä–æ—Å—Ç–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Python, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∞—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:

- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç NDJSON –≤ –≤–∏–¥–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏:
  `timestamp`, `endpoint`, `status`, `response_time_ms`).
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON-—Å—Ç—Ä–æ–∫—É —Å–æ —Å–≤–æ–¥–∫–æ–π:
  - `total` ‚Äî –æ–±—â–µ–µ —á–∏—Å–ª–æ –∑–∞–ø–∏—Å–µ–π,
  - `per_endpoint` ‚Äî –º–∞–ø–∞: `<endpoint>` -> –æ–±—ä–µ–∫—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π:
    - `count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–æ —ç—Ç–æ–º—É endpoint,
    - `success_2XX` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 200‚Äì299,
    - `errors_5XX` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 500‚Äì599,
    - `avg_ms` ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `response_time_ms`,
    - `p95_ms` ‚Äî 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –ø–æ `response_time_ms`.
- –í–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ JSON –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è `ValueError`.

–ö–æ–¥:

```python
import json
from math import ceil

def _parse_int(v):
    # –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ int
    try:
        return int(v)
    except Exception:
        raise ValueError("invalid integer value")

def _parse_float(v):
    try:
        return float(v)
    except Exception:
        raise ValueError("invalid float value")

def _percentile(values, p=95.0):
    # –æ–∂–∏–¥–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    if not values:
        return None
    if p <= 0:
        return values[0]
    if p >= 100:
        return values[-1]
    n = len(values)
    # –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–æ—Ä–º—É–ª—É –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞
    idx = int(ceil((p / 100.0) * n) - 1)
    idx = max(0, min(idx, n - 1))
    return values[idx]

def aggregate_ndjson(input_ndjson_str):
    # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –∏ –ø–∞—Ä—Å–∏–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É
    lines = input_ndjson_str.strip().splitlines()
    if not lines:
        raise ValueError("empty input")

    total = 0
    per_endpoint = {}

    for line_no, line in enumerate(lines, start=1):
        line = line.strip()
        if not line:
            continue  # –ø—Ä–æ–ø—É—Å–∫ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫, –Ω–æ —Å—á–∏—Ç–∞—è –∫–∞–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –Ω–µ –±—É–¥–µ–º
        try:
            obj = json.loads(line)
        except json.JSONDecodeError as e:
            # –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ ValueError (—Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑-–∑–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
            raise ValueError(f"Invalid JSON at line {line_no}: {e.msg}") from e

        # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        required = ["timestamp", "endpoint", "status", "response_time_ms"]
        for f in required:
            if f not in obj:
                raise ValueError(f"Missing required field '{f}' at line {line_no}")

        # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –ª—É—á—à–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å)
        endpoint = obj["endpoint"]
        status = obj["status"]
        rt = obj["response_time_ms"]

        # –¢–∏–ø–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if not isinstance(endpoint, str) or not endpoint:
            raise ValueError(f"Invalid endpoint at line {line_no}")

        status = int(status)
        rt = float(rt)

        # –æ–±–Ω–æ–≤–ª—è–µ–º –∞–≥—Ä–µ–≥–∞—Ü–∏—é
        rec = per_endpoint.setdefault(endpoint, {
            "count": 0,
            "success_2XX": 0,
            "errors_5XX": 0,
            "times": []
        })

        rec["count"] += 1
        if 200 <= status <= 299:
            rec["success_2XX"] += 1
        if 500 <= status <= 599:
            rec["errors_5XX"] += 1
        rec["times"].append(rt)

        total += 1

    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—ã–≤–æ–¥–∞
    output = {
        "total": total,
        "per_endpoint": {}
    }

    for ep, data in per_endpoint.items():
        times_sorted = sorted(data["times"])
        avg_ms = sum(times_sorted) / len(times_sorted) if times_sorted else None
        p95_ms = _percentile(times_sorted, 95.0) if times_sorted else None

        output["per_endpoint"][ep] = {
            "count": data["count"],
            "success_2XX": data["success_2XX"],
            "errors_5XX": data["errors_5XX"],
            "avg_ms": avg_ms,
            "p95_ms": p95_ms
        }

    return json.dumps(output, separators=(",", ":"), ensure_ascii=False)
```

–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:

- –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ CI –ª–∏–±–æ –∫–∞–∫ —á–∞—Å—Ç—å –Ω–µ–±–æ–ª—å—à–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∞:

```python
ndjson = '''{"timestamp": "2025-01-01T10:00:00Z", "endpoint":"/orders", "status": 200, "response_time_ms": 120}
{"timestamp":"2025-01-01T10:00:01Z", "endpoint":"/orders", "status": 500, "response_time_ms": 150}
{"timestamp":"2025-01-01T10:00:02Z", "endpoint":"/inventory", "status": 200, "response_time_ms": 95}'''

print(aggregate_ndjson(ndjson))
```

–í—ã–≤–æ–¥ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ:

```json
{"total":3,"per_endpoint":{"/orders":{"count":2,"success_2XX":1,"errors_5XX":1,"avg_ms":135.0,"p95_ms":150},"/inventory":{"count":1,"success_2XX":1,"errors_5XX":0,"avg_ms":95.0,"p95_ms":95.0}}}
```

–ó–∞–º–µ—á–∞–Ω–∏—è –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —É–ª—É—á—à–µ–Ω–∏–π:

- –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç p95 —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É–ª—É –∏–Ω–¥–µ–∫—Å–∞. –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å numpy.percentile –∏–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é.percentage-–ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏.
- –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ—Ç–æ–∫–æ–≤—ã–π —Ä–µ–∂–∏–º –¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤, –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –≤ –ø–∞–º—è—Ç–∏, –∞ —Å—á–∏—Ç–∞—Ç—å —Å–∫–æ–ª—å–∑—è—â–∏–º –æ–∫–Ω–æ–º –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (count, sums, –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è percentiles, –Ω–∞–ø—Ä–∏–º–µ—Ä, t-digest –∏–ª–∏ –∫–≤–∞–Ω—Ç–∏–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä).
- –í–∞–ª–∏–¥–∞—Ü–∏—é –º–æ–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å: –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `response_time_ms` –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π, —á—Ç–æ `timestamp` –∏–º–µ–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∏ —Ç.–¥. –ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –æ—Å–ª–æ–∂–Ω–∏—Ç—å –∫–æ–¥ –∏ —Å–Ω–∏–∑–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å, —Ç–∞–∫ —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ–ø—Ü–∏—é –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

–º–æ–≥—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –ø–æ–¥ —Å—Ç–∏–ª—å CI (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º, –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å numpy/pandas, –∏–ª–∏ –ø–æ—Ç–æ–∫–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É). –¢–∞–∫–∂–µ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –µ—â—ë –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è.


